---
title: "SpringBootã‹ã‚‰Elasticsearchã‚’ä½¿ã†æ–¹æ³•2é¸ (CREATE/READç·¨)"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [SpringBoot, Elasticsearch, Java]
published: true
---

:::message
æœ¬è¨˜äº‹ã¯ [ZOZO ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º #2 Advent Calendar 2020](https://qiita.com/advent-calendar/2020/zozo_tech2) ã® 8 æ—¥ç›®ã®è¨˜äº‹ã§ã™
:::

[å‰å›ã®è¨˜äº‹](https://zenn.dev/pakio/articles/be541633cf23d260819b)ã§ã¯ Spring Data Elasticsearch ã‚’ç”¨ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ/ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆæ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚
æœ¬ç¨¿ã§ã¯ã€å‰å›ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ™ãƒ¼ã‚¹ã«å®Ÿéš›ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® CREATE/READ æ“ä½œã‚’æ‰±ã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# TL;DR

ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ“ä½œã€ã‚¯ãƒ©ã‚¹ã‚¿ã®æ“ä½œå«ã‚ã¦å…¨èˆ¬çš„ã« Elasticsearch ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰‹è»½ã«å†ç¾ã—ãŸã„ã‚±ãƒ¼ã‚¹ã§ã¯ Rest High Level Client.
é€†ã«ã€æ¤œç´¢ãƒ»ã‚¤ãƒ³ãƒ‡ã‚­ã‚·ãƒ³ã‚°ç­‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ“ä½œç”¨é€”ã«çµã‚Œã¦ã€ã‹ã¤ä¸­ã«å…¥ã‚‹ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒ Object ã§å®šç¾©ã§ãã‚‹ã€å®šå‹ã®å ´åˆã¯ Spring Data Elasticsearch.
ãŸã ã—ã€å¾Œè€…ã«é–¢ã—ã¦ã¯ã»ã¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒãªã„ã®ã§ã€é ‘å¼µã‚ŠãŒå¿…è¦ã€‚

# CREATE (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¤ãƒ³ãƒ‡ã‚­ã‚·ãƒ³ã‚°)

## RestHighLevelClient

RestHighLevelClient ã‚’ç”¨ã„ãŸã‚¤ãƒ³ãƒ‡ã‚­ã‚·ãƒ³ã‚°å‡¦ç†ã¯ä»¥ä¸‹ã®æµã‚Œã¨ãªã‚Šã¾ã™ã€‚
ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦ã¯ Kibana ä¸Šã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹æ§˜ãªã€å®›å…ˆã€idã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã‚’ç™»éŒ²ã™ã‚‹æ“ä½œã‚’è¡Œã„ã¾ã™ã€‚
è¿”å´ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚‚ã€å®Ÿéš›ã«å¸°ã£ã¦ãã‚‹ JSON ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è©°ã‚ãŸæ§˜ãªå½¢å¼ã¨ãªã£ã¦ã„ã‚‹ãŸã‚ã€ã‚ã‚‹ç¨‹åº¦ Elasticsearch ã«æ…£ã‚ŒãŸæ–¹ã‹ã‚‰ã™ã‚‹ã¨ã‚ã‹ã‚Šã‚„ã™ã„å°è±¡ã§ã™ã€‚

ã“ã¡ã‚‰ã®å‡¦ç†ã«ãŠã‘ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå®šç¾©ã«ã¯ã€ãƒãƒƒãƒ”ãƒ³ã‚°ã®ç™»éŒ²åŒæ§˜ã® 3 ç¨® + ç‹¬è‡ªã® 1 ç¨®ã€åˆè¨ˆ 4 ç¨®é¡ã‹ã‚‰é¸æŠå¯èƒ½ã§ã™ã€‚

- ç”Ÿ Json æ–‡å­—åˆ—
- HashMap
- XContentBuilder
- IndexRequest ã«ç›´ã‚»ãƒƒãƒˆ

ä»Šå›ã¯ã€4 ç•ªç›®ã®æ–¹æ³•ã§ç´¹ä»‹ã„ãŸã—ã¾ã™ã€‚

RestHighLevelClientController.java

```java
...
@RequestMapping("/index-document")
public Boolean indexDocument(@RequestParam("id") Integer id, @RequestParam("message") String message) {
  return restHighLevelClientService.indexDocument(id, message);
}
...
```

ClientRepository.java

```java
public Boolean indexDocument(Integer id, String message) {
  IndexRequest request = new IndexRequest(indexName)
      .id(id.toString())
      .source("message", message);
  return clientRepository.indexDocument(request);
}
```

RestHighLevelClientRepository.java

```java
public Boolean indexDocument(IndexRequest request) {
  try {
    IndexResponse response = restHighLevelClient.index(request, RequestOptions.DEFAULT);
    return response.getResult() == Result.CREATED;
  } catch (Exception e) {
    return false;
  }
}
```

ã“ã“ã¾ã§å®Ÿè£…ã‚’è¡Œã£ã¦ãã¾ã—ãŸãŒã€ã„ãšã‚Œã® 4 ç¨®ã®æ–¹æ³•ã‚’ã¨ã£ã¦ã‚‚ã‚ã¾ã‚Šå¯èª­æ€§ãŒé«˜ã„ã¨ã¯è¨€ã„é›£ã„å®Ÿè£…ã¨ãªã£ã¦ã—ã¾ã¾ã™ã€‚
ãã“ã§å¹£ãƒãƒ¼ãƒ ã§ã¯ã€ä¸€æ—¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¯ç½®ã„ã¦ãŠãã€entity ã« JsonProperty ã‚’ä»˜ä¸ã— mapper ã§ JSON String ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹æ–¹æ³•ã‚’å–ã‚Šã¾ã—ãŸã€‚
ä»¥ä¸‹ãŒãã®ä¾‹ã§ã™ã€‚

DestIndex.java

```java
package com.pakio.demoelasticsearch.RestHighLevelClient.entity;

import com.fasterxml.jackson.annotation.JsonInclude;
import com.fasterxml.jackson.annotation.JsonInclude.Include;
import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Data;

@Data
@JsonInclude(Include.NON_NULL)
public class DestIndex {
  @JsonProperty("id")
  Integer id;

  @JsonProperty("message")
  String message;
}
```

RestHighLevelClientService.java

```java
public Boolean indexDocument(DestIndex destIndex) {
  ObjectMapper mapper = new ObjectMapper();

  try {
    IndexRequest request = new IndexRequest(indexName).id(destIndex.getId().toString())
        .source(mapper.writeValueAsString(destIndex), XContentType.JSON);

    return clientRepository.indexDocument(request);
  } catch (Exception e) {
    return false;
  }
}
```

### SpringDataElasticsearch

æ¬¡ã«ã€SpringDataElasticsearch ã‚’ç”¨ã„ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¤ãƒ³ãƒ‡ã‚­ã‚·ãƒ³ã‚°å‹•ä½œã§ã™ã€‚
ã“ã¡ã‚‰ã¯ã€[å‰å›ã®è¨˜äº‹](https://zenn.dev/pakio/articles/be541633cf23d260819b)ã§ä½œæˆã—ãŸ Entity ã‚’ä½¿ã„ã¾ã‚ã—ã¦å®Ÿè£…ãŒå¯èƒ½ã§ã™ã€‚
ãã®ãŸã‚ã€ãƒãƒƒãƒ”ãƒ³ã‚°ã¨å®Ÿéš›ã«å…¥ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒé•ã†ã€ã¨ã„ã£ãŸãƒˆãƒ©ãƒ–ãƒ«ã‚’é˜²ãã“ã¨ãŒå®¹æ˜“ãªå°è±¡ã‚’å—ã‘ã¾ã—ãŸã€‚

SpringDataElasticsearchController.java

```java
@RequestMapping("/index-document")
public Boolean indexDocument(@RequestParam("id") Integer id, @RequestParam("message") String message) {
  return springDataElasticsearchService.indexDocument(id, message);
}
```

SpringDataElaticsearchService.java

```java
public Boolean indexDocument(Integer id, String message) {
  DestIndex destIndex = new DestIndex();
  destIndex.setId(id.toString());
  destIndex.setMessage(message);

  try {
    this.elasticsearchOperations.save(destIndex);
    return true;
  } catch (Exception e) {
    return false;
  }
}
```

æ³¨æ„ç‚¹ãŒï¼’ç‚¹ã»ã©ã‚ã‚Šã€ã¾ãšï¼‘ç‚¹ç›®ã¨ã—ã¦ã€ElasticsearchOperations ã® save ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿”å€¤ã¯å…¥åŠ›ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¯ãƒ©ã‚¹ãã®ã¾ã¾ã‚’è¿”ã™ãŸã‚ã€çµæœã®å‚ç…§ãŒè¡Œãˆã¾ã›ã‚“
ï¼’ç‚¹ç›®ã§ã™ãŒã€ä½œæˆã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã« \_class ã¨ã„ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚Œã€ä½¿ç”¨ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æƒ…å ±ãŒä¿æŒã•ã‚Œã‚‹ãŸã‚ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚µã‚¤ã‚ºã‚’æ°—ã«ã•ã‚Œã‚‹æ–¹ã«ã¯å‘ã‹ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚\_class ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¿ã‚¤ãƒ—ã¯ text ã§ã™ã€‚

```json
...
"hits": [
    {
        "_index": "dest_index2",
        "_type": "_doc",
        "_id": "1",
        "_score": 1,
        "_source": {
            "_class": "com.pakio.demoelasticsearch.SpringDataElasticsearch.entity.DestIndex",
            "id": "1",
            "message": "hoge"
        }
    }
]
...
```

# READ (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å–å¾—)

Read å‡¦ç†ã¯\_id æŒ‡å®šã® search ã‚’æ¡ä»¶ã«æ¯”è¼ƒã—ã¦ã¿ã¾ã™ã€‚

## RestHighLevelClient

Rest High Level Client ã§ã¯ã€ã“ã¡ã‚‰ã‚‚åŒæ§˜ã« Kibana ã® UI ä¸Šã‹ã‚‰ã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰ã™ã‚‹ã®ã¨åŒã˜æ„Ÿè¦šã§ã‚¯ã‚¨ãƒªæ§‹ç¯‰ã‚’è¡Œã„ã¾ã™ã€‚

RestHighLevelClientController.java

```java
@RequestMapping("/get-document")
public ResponseEntity<DestIndex> getDocument(@RequestParam("id") Integer id) {
  DestIndex doc = restHighLevelClientService.getDocumentById(id);
  return new ResponseEntity<DestIndex>(doc, HttpStatus.OK);
}
```

RestHighLevelClientService.java

```java
public DestIndex getDocumentById(Integer id) {
  SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();

  TermQueryBuilder termQueryBuilder = QueryBuilders.termQuery("_id", id);
  searchSourceBuilder.query(termQueryBuilder);

  SearchRequest request = new SearchRequest(indexName);
  request.source(searchSourceBuilder);

  SearchResponse response =  clientRepository.getDocument(request);

  SearchHit[] searchHits = response.getHits().getHits();
  Optional<SearchHit> optionalSearchHit = Arrays.stream(searchHits).findFirst();

  if(optionalSearchHit.isPresent()) {
    return convertSearchHitToEntity(optionalSearchHit.get());
  } else {
    return new DestIndex();
  }
}

public static DestIndex convertSearchHitToEntity(SearchHit searchHit) {
  String jsonString = searchHit.getSourceAsString();

  ObjectMapper mapper = new ObjectMapper();
  try {
    DestIndex destIndex = mapper.readValue(jsonString, DestIndex.class);

    return destIndex;
  } catch (Exception e) {
    return new DestIndex();
  }
}
```

ClientRepository.java

```java
public SearchResponse getDocument(SearchRequest request) {
  try {
    return restHighLevelClient.search(request, RequestOptions.DEFAULT);
  } catch (Exception e) {
    this.setClient(restHighLevelClientConfig.getRecreateClient());
    return null;
  }
}
```

ã ã„ã¶è¤‡é›‘ã«ãªã£ã¦ãã¾ã—ãŸã€‚ç‰¹ã« SearchResponse ã‹ã‚‰ SearchHit[]ã‚’å–ã‚Šå‡ºã™ã‚ãŸã‚Šãªã‚“ã‹ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®å¤§å¹…ãªå¤‰æ›´ãŒã‚ã‚‹å ´åˆå¤§å¤‰ãã†ã§ã™ã­ã€‚

## SpringDataElasticsearch

æ¬¡ã« SpringDataElasticsearch ã®ä¾‹ã§ã™ã€‚

SpringDataElasticsearchController.java

```java
@RequestMapping("/get-document")
public ResponseEntity<DestIndex> getDocument(@RequestParam("id") Integer id) {
  DestIndex doc = springDataElasticsearchService.getDocumentById(id);
  return new ResponseEntity<DestIndex>(doc, HttpStatus.OK);
}
```

SpringDataElasticsearchService.java

```java
public DestIndex getDocumentById(Integer id){
  return this.elasticsearchOperations.get(id.toString(), DestIndex.class);
}
```

ã“ã†ãªã£ã¦ãã‚‹ã¨é•ã„ã¯ä¸€ç›®ç­ç„¶ã€Spring Data Elasticsearch ãŒå…¨æ“ä½œã®å†ç¾ã§ãªãã€ãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„ã«ã„ã‹ã«é‡ãã‚’ç½®ã„ã¦ã„ã‚‹ã®ã‹ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ä¸Šè¨˜ã¯ id ã§å¼•ãã«è¡Œãä¾‹ã ã£ãŸã®ã§ã“ã‚Œã»ã©ç¶ºéº—ã«ã‹ã‘ã¾ã—ãŸãŒã€Rest High Level Client ã¨åŒæ§˜ã« term ã‚¯ã‚¨ãƒªã§\_id ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¯¾ã—ã¦æ¤œç´¢ã‚’ã‹ã‘ã‚‹ã‚±ãƒ¼ã‚¹ã ã¨ã€ä»¥ä¸‹ã®æ§˜ãªå½¢ã¨ãªã‚Šã¾ã™ã€‚

SpringDataElasticsearchService.java

```java
public DestIndex getDocumentByIdWithQuery(Integer id) {
  StringQuery query  = new StringQuery(QueryBuilders.termQuery("_id", id).toString());

  return this.elasticsearchOperations.searchOne(query, DestIndex.class).getContent();
}
```

çµå±€ã®ã¨ã“ã‚ã€çµæœã®å–å¾—ã« QueryBuilder ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã«å¤‰ã‚ã‚Šã¯ãªã„ã‚ˆã†ã§ã™ãŒã€entity ã¸ã®å¤‰æ›ã¯ã‹ãªã‚Šã‚¹ãƒãƒ¼ãƒˆã«æ€ãˆã¾ã™ã€‚

# ã¾ã¨ã‚

æœ¬ç¨¿ã§ã¯ Spring Boot ã‹ã‚‰ Elasticsearch ã«æ¥ç¶šã™ã‚‹ä¸»ãª 2 æ–¹æ³•ã«ã¤ã„ã¦ã€å®Ÿéš›ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ“ä½œæ–¹æ³•å«ã‚ã¦ç´¹ä»‹ã„ãŸã—ã¾ã—ãŸã€‚
æ¬¡ã®è¨˜äº‹ã§ã¯ã€æ®‹ã‚‹ 2 æ“ä½œã€UPDATE, DELETE ã«ã¤ã„ã¦ã¾ã¨ã‚ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# ãƒªãƒã‚¸ãƒˆãƒª

ã“ã“ã¾ã§ç™»å ´ã—ãŸã‚³ãƒ¼ãƒ‰é¡ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¨ã¦å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚
ã‚‚ã—é–“é•ã„ã‚„æ”¹å–„æ¡ˆç­‰ã‚ã‚Šã¾ã—ãŸã‚‰ã“ã¡ã‚‰ã¾ã§ã”å ±å‘ŠãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
[pakio/spring-elasticsearch-client-comparison](https://github.com/pakio/spring-elasticsearch-client-comparison)

# å‚è€ƒ

[Spring Data Elasticsearch - Reference Documentation](https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/#reference)
[Elasticsearch Java API å…¥é–€](https://techblog.zozo.com/entry/elasticsearch-java)
