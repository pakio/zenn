---
title: "SpringBootã‹ã‚‰Elasticsearchã‚’ä½¿ã†æ–¹æ³•2é¸(ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ/ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆ)"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [SpringBoot, Elasticsearch, Java]
published: false
---

:::message
æœ¬è¨˜äº‹ã¯ [ZOZO ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º #2 Advent Calendar 2020](https://qiita.com/advent-calendar/2020/zozo_tech2) ã® 7 æ—¥ç›®ã®è¨˜äº‹ã§ã™
:::

æœ¬è¨˜äº‹ã§ã¯ 2020 å¹´ 12 æœˆç¾åœ¨ Java(Spring Boot)ã‚’ä½¿ç”¨ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ Elasticsearch ã«æ¥ç¶šã™ã‚‹éš›ã«ä¸»ã«å€™è£œã§ä¸ŠãŒã‚‹ã§ã‚ã‚ã†

- Elasticsearch Rest High Level Client
- Spring Data Elasticsearch

ã® 2 ã¤ã®æ–¹æ³•ã«ã¤ã„ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç”Ÿæˆæ–¹æ³•ã‚„è¨­å®šæ–¹æ³•ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆæ–¹æ³•ã¾ã§ã‚’æ¯”è¼ƒã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚
ãªãŠã€æœ¬ç¨¿ã§ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç­‰ã¯ Bean ã«ç™»éŒ²ã—ãŸä¸Šã§æ°¸ç¶šåŒ–ã•ã›ãŸçŠ¶æ…‹ã§ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ

## Rest High Level Client

Rest High Level Client ã‚’æ°¸ç¶šåŒ–ã—ãŸä¸Šã§åˆ©ç”¨ã™ã‚‹ã«ã¯ã€è‰²ã€…æ‰‹æ®µã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ãŒã€ä»Šå›ã¯ã‚ˆãåˆ©ç”¨ã—ã¦ã„ã‚‹æ–¹æ³•ã§è¨˜è¿°ã—ã¦ã¿ã¾ã™ã€‚

RestHighLevelClientConfig.java

```java
package com.pakio.demoelasticsearch.RestHighLevelClient.client;

import org.apache.http.HttpHost;
import org.elasticsearch.client.RestClient;
import org.elasticsearch.client.RestHighLevelClient;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.stereotype.Component;

@Component
@Configuration
public class RestHighLevelClientConfig {

  @Value("${spring.elasticsearch.host}")
  private String host;

  @Value("${spring.elasticsearch.port}")
  private Integer port;

  @Value("${spring.elasticsearch.https}")
  private Boolean https;

  @Bean(name = "restHighLevelClient", destroyMethod = "close")
  RestHighLevelClient client() {
    return getClient();
  }

  private RestHighLevelClient getClient() {
    RestHighLevelClient client = new RestHighLevelClient(
        RestClient.builder(new HttpHost(host, port, https ? "https" : "http"))
            .setHttpClientConfigCallback(httpAsyncClientBuilder -> httpAsyncClientBuilder)
            .setRequestConfigCallback(requestConfigBuilder -> requestConfigBuilder)
    );
    return client;
  }
}
```

ClientRepository.java

```java
package com.pakio.demoelasticsearch.RestHighLevelClient.client;

import org.elasticsearch.action.search.SearchRequest;
import org.elasticsearch.client.RequestOptions;
import org.elasticsearch.client.RestHighLevelClient;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;

@Repository
public class ClientRepository {
  @Autowired
  private RestHighLevelClientConfig restHighLevelClientConfig;

  private RestHighLevelClient restHighLevelClient;

  @Autowired
  public void setClient(RestHighLevelClient restHighLevelClient) {
    this.restHighLevelClient = restHighLevelClient;
  }
}
```

ä¸Šè¨˜ã®è¨­å®šã‚’è¡Œã†ã“ã¨ã«ã‚ˆã‚Šã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ Bean ã¨ã—ã¦ç™»éŒ²ã—ãŸä¸Šã§ä½¿ã„å›ã™ã“ã¨ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

Bean ã«ç™»éŒ²ã—ã¦ä½¿ç”¨ã™ã‚‹æ³¨æ„ç‚¹ã¨ã—ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæ„å›³ã›ã¬åŸå› ã§ Closed ãªçŠ¶æ…‹ã«ãªã£ãŸéš›ã«ã€Bean ã«ç™»éŒ²ã•ã‚ŒãŸåŒä¸€ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆ©ç”¨ã—ã‚ˆã†ã¨ã—ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚
ãã®å›é¿ç­–ã¨ã—ã¦ã€ä¸Šè¨˜ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”¨ã„ãŸæ¤œç´¢å‡¦ç†ã®éƒ¨åˆ†ã§ RestHighLevelClientConfig.getClient ã‚’å‘¼ã¶ã“ã¨ãŒå¯èƒ½ãª public ãªé–¢æ•°ã‚’ç”¨æ„ã—ã¦ãŠãã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å†ä½œæˆã™ã‚‹ã“ã¨ã§å›é¿ã—ã¦ã„ã¾ã™ã€‚

RestHighLevelClientConfig.java

```java
...
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå†ç”Ÿæˆç”¨ãƒ¡ã‚½ãƒƒãƒ‰
public RestHighLevelClient getRecreateClient() {
  return this.getClient();
}
...
```

ClientRepository.java

```java
...
public SearchResponse getSearchResult(SearchRequest request) {
  try {
    return restHighLevelClient.search(request, RequestOptions.DEFAULT);
  } catch (Exception e) {
    this.setClient(restHighLevelClientConfig.getRecreateClient()); //ä½•ã‚‰ã‹ã®ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸå ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å·®ã—æ›¿ãˆã‚‹
    return null;
  }
}
...
```

## Spring Data Elasticsearch

Spring Data Elasticsearch ã¯å†…éƒ¨çš„ã«åˆ©ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä»¥ä¸‹ã‹ã‚‰é¸æŠã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

- Transport Client
- Rest Low Level Client
- Rest High Level Client

ä»Šå›ã¯ã€ã“ã®ä¸­ã§ã‚‚æœ€ã‚‚é«˜æ©Ÿèƒ½ãª Rest High Level Client ã‚’ä¾‹ã«å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚

```java
package com.pakio.demoelasticsearch.SpringDataElasticsearch.client;

import org.apache.http.HttpHost;
import org.elasticsearch.client.RestClient;
import org.elasticsearch.client.RestHighLevelClient;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.elasticsearch.config.AbstractElasticsearchConfiguration;
import org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate;
import org.springframework.stereotype.Component;

@Component
@Configuration
public class ElasticsearchRestTemplateConfig extends AbstractElasticsearchConfiguration {

  @Value("${spring.elasticsearch.host}")
  private String host;

  @Value("${spring.elasticsearch.port}")
  private Integer port;

  @Value("${spring.elasticsearch.https}")
  private Boolean https;

  @Bean
  RestHighLevelClient client() {
    return getClient();
  }

  private RestHighLevelClient getClient() {
    RestHighLevelClient client = new RestHighLevelClient(
        RestClient.builder(new HttpHost(host, port, https ? "https" : "http"))
            .setHttpClientConfigCallback(httpAsyncClientBuilder -> httpAsyncClientBuilder)
            .setRequestConfigCallback(requestConfigBuilder -> requestConfigBuilder)
    );
    return client;
  }

  @Override
  public RestHighLevelClient elasticsearchClient() {
    return this.getClient();
  }
}
```

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚ã‚ã‚‹é€šã‚Šã€ã“ã®ç”Ÿæˆæ–¹æ³•ã‚’åˆ©ç”¨ã™ã‚‹ã¨ Bean ã®ç‰¹åˆ¥ãªå®šç¾©ã®å¿…è¦ãªã—ã«ç”Ÿæˆã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

# Create Index Request

## Rest High Level Client

Rest High Level Client ã‚’ç”¨ã„ã¦ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆã¯ä»¥ä¸‹ã® 3 ç¨®é¡ãŒé¸æŠå¯èƒ½ã§ã™ã€‚

- ç”Ÿ Json æ–‡å­—åˆ—
- HashMap
- XContentBuilder

ä»Šå›ã¯ HashMap ã§ã®ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®šç¾©

IndexMapping.java

```java
package com.pakio.demoelasticsearch.RestHighLevelClient.entity;

import java.util.HashMap;
import java.util.Map;

public class IndexMapping {
  public static Map getIndexMapping() {
    Map<String, Object> jsonMap = new HashMap<>();
    Map<String, Object> message = new HashMap<>();
    message.put("type", "text");
    Map<String, Object> properties = new HashMap<>();
    properties.put("message", message);
    jsonMap.put("properties", properties);

    return jsonMap;
  }
}
```

RestHighLevelClientService.java

```java
package com.pakio.demoelasticsearch.RestHighLevelClient.service;

import com.pakio.demoelasticsearch.RestHighLevelClient.client.ClientRepository;
import com.pakio.demoelasticsearch.RestHighLevelClient.entity.IndexMapping;
import java.util.Map;
import org.elasticsearch.client.indices.CreateIndexRequest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class RestHighLevelClientService {
  @Autowired
  ClientRepository clientRepository;

  public String createIndex() {
    Map mapping = IndexMapping.getIndexMapping();
    CreateIndexRequest request = new CreateIndexRequest("dest_index");
    request.source(mapping);
    if (clientRepository.createIndex(request).isAcknowledged()) {
      return "ok";
    } else {
      return "ng";
    }
  }
}
```

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆç”¨å‡¦ç†

RestHighLevelClientController.java

```java
package com.pakio.demoelasticsearch.RestHighLevelClient.controller;

import com.pakio.demoelasticsearch.RestHighLevelClient.service.RestHighLevelClientService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/rest-high-level-client")
public class RestHighLevelClientController {

  @Autowired
  RestHighLevelClientService restHighLevelClientService;

  @RequestMapping("/create-index")
  public String createIndex() {
		return restHighLevelClientService.createIndex();
  }

}
```

ClientRepository.java

```java
...
public AcknowledgedResponse createIndex(CreateIndexRequest request) {
    try {
      return restHighLevelClient.indices().create(request, RequestOptions.DEFAULT);
    } catch (Exception e) {
      System.out.println(e.getCause());
      System.out.println(e.getMessage());
      this.setClient(restHighLevelClientConfig.getRecreateClient());
      return null;
    }
  }
...
```

## Spring Data Elasticsearch

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®šç¾©

Spring Data Elasticsearch ã§ã¯ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å†…éƒ¨ã®æ§‹é€ ã‚’ã‚¯ãƒ©ã‚¹ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚

DestIndex.java

```java
package com.pakio.demoelasticsearch.SpringDataElasticsearch.entity;

import org.springframework.data.elasticsearch.annotations.Document;
import org.springframework.data.elasticsearch.annotations.Field;
import org.springframework.data.elasticsearch.annotations.FieldType;

@Document(indexName = "dest_index2")
public class DestIndex {
  @Field(type= FieldType.Text)
  String message;

  public String getMessage() {
    return this.message;
  }
}
```

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆå‡¦ç†

å†…éƒ¨çš„ã«ã¯ Elasticsearch å…¬å¼ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã® 3 ç¨®ã‚’å…¨ã¦ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒã€TransportClient ã«é–¢ã—ã¦ã¯ deprecated ã¨ãªã£ã¦ã„ã¾ã™ã€‚
ä»Šå›ã®ãƒ‡ãƒ¢ã§ã¯å…ˆã»ã©ã¨åŒæ§˜ã« RestHighLevelClient ã‚’ä¾‹ã«å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚

ElasticsearchRestTemplate.java

```java
package com.pakio.demoelasticsearch.SpringDataElasticsearch.client;

import org.apache.http.HttpHost;
import org.elasticsearch.client.RestClient;
import org.elasticsearch.client.RestHighLevelClient;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.elasticsearch.config.AbstractElasticsearchConfiguration;
import org.springframework.stereotype.Component;

@Component
@Configuration
public class ElasticsearchRestTemplate extends AbstractElasticsearchConfiguration {

  @Value("${spring.elasticsearch.host}")
  private String host;

  @Value("${spring.elasticsearch.port}")
  private Integer port;

  @Value("${spring.elasticsearch.https}")
  private Boolean https;

  @Bean
  RestHighLevelClient client() {
    return getClient();
  }

  private RestHighLevelClient getClient() {
    RestHighLevelClient client = new RestHighLevelClient(
        RestClient.builder(new HttpHost(host, port, https ? "https" : "http"))
            .setHttpClientConfigCallback(httpAsyncClientBuilder -> httpAsyncClientBuilder)
            .setRequestConfigCallback(requestConfigBuilder -> requestConfigBuilder)
    );
    return client;
  }

  @Override
  public RestHighLevelClient elasticsearchClient() {
    return this.getClient();
  }
}
```

SpringDataElaticsearchService.java

```java
package com.pakio.demoelasticsearch.SpringDataElasticsearch.service;

import com.pakio.demoelasticsearch.SpringDataElasticsearch.entity.DestIndex;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.elasticsearch.core.ElasticsearchOperations;
import org.springframework.data.elasticsearch.core.IndexOperations;
import org.springframework.stereotype.Service;

@Service
public class SpringDataElasticsearchService {
  private final ElasticsearchOperations elasticsearchOperations;

  @Autowired
  public SpringDataElasticsearchService(ElasticsearchOperations elasticsearchOperations) {
    this.elasticsearchOperations = elasticsearchOperations;
  }

  public Boolean createIndex() {
    IndexOperations operations = this.elasticsearchOperations.indexOps(DestIndex.class);
    return operations.create();
  }
}
```

SpringDataElasticsearchController.java

```java
package com.pakio.demoelasticsearch.SpringDataElasticsearch.controller;

import com.pakio.demoelasticsearch.SpringDataElasticsearch.service.SpringDataElasticsearchService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/spring-data-elasticsearch")
public class SpringDataElasticsearchController {
  @Autowired
  SpringDataElasticsearchService springDataElasticsearchService;

  @RequestMapping("/create-index")
  public String createIndex() {
    return springDataElasticsearchService.createIndex().toString();
  }

}
```

ã“ã“ã§ã€AbstractElasticsearchConfiguration ã¯ ElasticsearchOperations ã‚’ç¶™æ‰¿ã—ã¦ãŠã‚Šã€Bean ã¸ã®ç™»éŒ²ã®æ˜è¨˜ãªã—ã« Autowired ã§åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

# ã¾ã¨ã‚

æœ¬ç¨¿ã§ã¯ Spring Boot ã‹ã‚‰ Elasticsearch ã«æ¥ç¶šã™ã‚‹ä¸»ãª 2 æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚
æ˜æ—¥ã¯ã‚‚ã†å°‘ã—è©³ç´°ã€CRUD æ“ä½œã«ã¤ã„ã¦ã¾ã¨ã‚ã¦ã¿ã¾ã™ã€‚

# ãƒªãƒã‚¸ãƒˆãƒª

ã“ã“ã¾ã§ç™»å ´ã—ãŸã‚³ãƒ¼ãƒ‰é¡ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¨ã¦å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚
ã‚‚ã—é–“é•ã„ã‚„æ”¹å–„æ¡ˆç­‰ã‚ã‚Šã¾ã—ãŸã‚‰ã“ã¡ã‚‰ã¾ã§ã”å ±å‘ŠãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
[pakio/spring-elasticsearch-client-comparison](https://github.com/pakio/spring-elasticsearch-client-comparison)

# å‚è€ƒ

[Spring Data Elasticsearch - Reference Documentation](https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/#reference)
[Elasticsearch Java API å…¥é–€](https://techblog.zozo.com/entry/elasticsearch-java)
