---
title: "Elasticsearchã§ã‚‚SQLæ›¸ããŸã„ï¼ Opendistro for Elasticsearch SQLå…¥é–€"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Java, Elasticsearch, SQL]
published: true
---

:::message
æœ¬è¨˜äº‹ã¯ [ZOZO ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º #2 Advent Calendar 2020](https://qiita.com/advent-calendar/2020/zozo_tech2) ã® 19 æ—¥ç›®ã®è¨˜äº‹ã§ã™
:::

ã¿ãªã•ã‚“ã€SQL ã¯å¥½ãã§ã™ã‹ã€‚

Elasticsearch æ›¸å­¦è€…ã¨ã—ã¦ã®ç¬¬ä¸€é–¢é–€ã¨ã—ã¦ã€ç‹¬è‡ªã®ã‚¯ã‚¨ãƒªæ§‹æ–‡ã«æ…£ã‚Œãªã„ã¨ã„ã†ã‚±ãƒ¼ã‚¹ã¯ã‚ã‚‹ã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚ã¾ãŸã€**Elasticsearch ã®ã‚¯ã‚¨ãƒªã¯æ›¸ã‘ãªã„ã‘ã©ã€SQL ãªã‚‰æ›¸ã‘ã‚‹**ã¨ã„ã†æ–¹ã‚‚å¤§å‹¢ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

æœ¬æŠ•ç¨¿ã§ã¯ã€ãã‚“ãªæ–¹ã€…ã®ãŸã‚ã« Elasticsearch ã«å¯¾ã—ã¦ SQL ã‚’ç™ºè¡Œã—ã€ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Šã‚’è¡Œã†æ–¹æ³•ã‚’ã”ç´¹ä»‹ã„ãŸã—ã¾ã™ã€‚
ãªãŠã€ä»Šå›ã®æ¤œè¨¼ã§ã¯ã€Kibana èµ·å‹•æ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¯èƒ½ãª**Sample eCommerce orders**ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ã¾ã™ã€‚

ä»Šå›ã®æ¤œè¨¼ã§ã¯ã€Apache License ã§åˆ©ç”¨å¯èƒ½ãª[Open Distro for Elasticsearch SQL](https://opendistro.github.io/for-elasticsearch-docs/docs/sql/)(ä»¥ä¸‹ã€odfe)ã‚’ç”¨ã„ã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ã‚¯ãƒ©ã‚¹ã‚¿ã®ç«‹ã¡ä¸Šã’ã«ã¯ docker-compose ã‚’ç”¨ã„ã¾ã™ãŒã€è©³ç´°ã¯åŒæœŸã®[@ke-bo](https://github.com/ke-bo)ãŒæ›¸ã„ãŸ[ã“ã¡ã‚‰](https://qiita.com/ke-bo/items/690f57a3337e694afc7e)ã®è¨˜äº‹ã‚’ã”è¦§ãã ã•ã„ã€‚

# Kibana ä¸Šã‹ã‚‰ SQL ã‚’å©ã„ã¦ã¿ã‚‹

odfe ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒé©ç”¨ã•ã‚ŒãŸ Kibana ã‚’èµ·å‹•ã™ã‚‹ã¨ã€ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ Query Workbench ãŒé¸æŠå¯èƒ½ã§ã™ã€‚
![kibana](https://storage.googleapis.com/zenn-user-upload/wduuahm8v6yoser57gaav586x56o)

Workbench ã‚’é–‹ãã¨ã€æ—©é€Ÿã‚¯ã‚¨ãƒªã‚’å…¥åŠ›ã™ã‚‹ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
![workbench](https://storage.googleapis.com/zenn-user-upload/qs9ukpz66da7dxmlzxmm82uolzxr)

åˆæœŸå€¤ã§å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‚¯ã‚¨ãƒªã‚’`RUN`ã‚’æŠ¼ã—ã¦å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚¯ãƒ©ã‚¹ã‚¿å†…å…¨ã¦ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§å–å¾—ã§ãã¾ã™ã€‚
![index_list](https://storage.googleapis.com/zenn-user-upload/nmeqcyvryxd3008x4c4uv96zioyj)

ã¾ãŸã€æ¨ªã«ã‚ã‚‹`Explain`ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€å†…éƒ¨ã§ã©ã®æ§˜ãªã‚¯ã‚¨ãƒªã«å¤‰æ›ã•ã‚Œã¦ã„ã‚‹ã‹ãŒç¢ºèªå¯èƒ½ã§ã™ã€‚
è©¦ã—ã«ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã‚’å¤‰æ›ã—ã¦ã¿ã¾ã™ã€‚

```sql
SELECT * FROM kibana_sample_data_ecommerce;
```

![explain](https://storage.googleapis.com/zenn-user-upload/famnz190fzsgptatycglua4z9tzp)

# å®Ÿè·µ

ã“ã“ã‹ã‚‰ã¯å®Ÿéš›ã®æ“ä½œã‚’æƒ³å®šã—ãŸã‚¯ã‚¨ãƒªã¨ã€ã©ã®æ§˜ã«è§£é‡ˆã•ã‚Œã¦ã„ã‚‹ã‹ã‚’å®Ÿéš›ã«å®Ÿè¡Œã—ãªãŒã‚‰ç¢ºã‹ã‚ã¦ã¿ã¾ã™ã€‚

## order_id é™é †ã§ Top10 ã‚’ã¨ã‚‹

```sql
SELECT * FROM kibana_sample_data_ecommerce ORDER BY order_id DESC LIMIT 10;
```

```json
{
  "from": 0,
  "size": 10,
  "sort": [
    {
      "order_id": {
        "order": "desc"
      }
    }
  ]
}
```

![top10](https://storage.googleapis.com/zenn-user-upload/p8ly56zkp3uf0lueilf9g4o1462v)

## customer_first_name ã‚’é‡è¤‡æ’é™¤ã—ã¦å–å¾—

```sql
SELECT DISTINCT customer_first_name from kibana_sample_data_ecommerce;
```

```json
{
  "from": 0,
  "size": 0,
  "_source": {
    "includes": ["customer_first_name"],
    "excludes": []
  },
  "stored_fields": "customer_first_name",
  "aggregations": {
    "customer_first_name": {
      "terms": {
        "field": "customer_first_name",
        "size": 200,
        "min_doc_count": 1,
        "shard_min_doc_count": 0,
        "show_term_doc_count_error": false,
        "order": [
          {
            "_count": "desc"
          },
          {
            "_key": "asc"
          }
        ]
      }
    }
  }
}
```

ã“ã‚Œã¯å®Ÿéš›ã«å®Ÿè¡Œã™ã‚‹ã¨ã€customer_first_name ãŒ text type ã®ãŸã‚æ€’ã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã™ã­ã€‚æ­£ã—ãã¯ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã¨ãªã‚Šãã†ã§ã™ã€‚

```json
{
  "from": 0,
  "size": 0,
  "_source": {
    "includes": ["customer_first_name"],
    "excludes": []
  },
  "stored_fields": "customer_first_name",
  "aggregations": {
    "customer_first_name": {
      "terms": {
        "field": "customer_first_name.keyword",
        "size": 200,
        "min_doc_count": 1,
        "shard_min_doc_count": 0,
        "show_term_doc_count_error": false,
        "order": [
          {
            "_count": "desc"
          },
          {
            "_key": "asc"
          }
        ]
      }
    }
  }
}
```

SQL ã§æ˜ç¤ºçš„ã« keyword ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã‚‚å¯¾å¿œå¯èƒ½ã§ã—ãŸã€‚

```sql
SELECT DISTINCT customer_first_name.keyword from kibana_sample_data_ecommerce;
```

![distinct](https://storage.googleapis.com/zenn-user-upload/zlz3d31vr3awzeng1h9r319ehzib)

## taxless_total_price ãŒ 100 ä»¥ä¸Š 200 ä»¥ä¸‹ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—

```sql
SELECT * FROM kibana_sample_data_ecommerce WHERE taxless_total_price BETWEEN 100 AND 200;
```

```json
{
  "from": 0,
  "size": 200,
  "query": {
    "bool": {
      "filter": [
        {
          "bool": {
            "must": [
              {
                "range": {
                  "taxless_total_price": {
                    "from": 100,
                    "to": 200,
                    "include_lower": true,
                    "include_upper": true,
                    "boost": 1
                  }
                }
              }
            ],
            "adjust_pure_negative": true,
            "boost": 1
          }
        }
      ],
      "adjust_pure_negative": true,
      "boost": 1
    }
  }
}
```

![where](https://storage.googleapis.com/zenn-user-upload/bxo4rivlruqzdnwqi49xj6mhj6eg)

## é¡§å®¢åã”ã¨ã«æ³¨æ–‡ä»¶æ•°ã‚’å–å¾—

ã“ã®è¾ºã‚Šã®è¤‡é›‘ãªã¨ã“ã‚ã‹ã‚‰ã€workbench å´ã§å¯¾å¿œä»•åˆ‡ã‚Œãšã‚¨ãƒ©ãƒ¼ã«ãªã‚Šå§‹ã‚ã¾ã™ã€‚ãŒã€Explain ã§ã§ã¦ãã‚‹ã‚¯ã‚¨ãƒªã‚’ Dev Tools ä¸Šã§æŠ•ã’ã‚‹ã“ã¨ã§çµæœã®å–å¾—ãŒã§ãã¾ã™ãŒã€ã“ã‚Œã‚‰ã‚‚æ„è­˜ã—ã¦ keyword å‹ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§å›é¿å¯èƒ½ã§ã™ã€‚(ã¡ã‚‡ã£ã¨ SQL ã‚‰ã—ã•ã¯è–„ã‚Œã¦ãã¾ã™ã­)

```sql
SELECT COUNT(customer_full_name.keyword), customer_full_name.keyword FROM kibana_sample_data_ecommerce GROUP BY customer_full_name.keyword;
```

```json
{
  "from": 0,
  "size": 0,
  "_source": {
    "includes": ["customer_full_name.keyword", "COUNT"],
    "excludes": []
  },
  "stored_fields": "customer_full_name.keyword",
  "aggregations": {
    "customer_full_name#keyword": {
      "terms": {
        "field": "customer_full_name.keyword",
        "size": 200,
        "min_doc_count": 1,
        "shard_min_doc_count": 0,
        "show_term_doc_count_error": false,
        "order": [
          {
            "_count": "desc"
          },
          {
            "_key": "asc"
          }
        ]
      },
      "aggregations": {
        "COUNT_0": {
          "value_count": {
            "field": "customer_full_name.keyword"
          }
        }
      }
    }
  }
}
```

![grpup by](https://storage.googleapis.com/zenn-user-upload/5n03cv2j68guyh2yamoukgvfig4p)

Aggregation ã‚’ä½¿ã£ã¦ GROUP BY ã‚’å†ç¾ã—ã¦ã„ã‚‹ã®ã§ã€é™é †ã«ä¸¦ã‚“ã§ã„ã‚‹ã®ãŒé¢ç™½ã„ã§ã™ã­ã€‚

# ã•ã‚‰ã«è¤‡é›‘ãªã‚¯ã‚¨ãƒªæ§‹æ–‡ã¸ãƒ»ãƒ»ãƒ»

ã“ã“ã‹ã‚‰ã¯ JOIN ã‚’ä½¿ã£ã¦ã¿ã¾ã™ã€‚å®Ÿã¯ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã¯åŸ·ç­†æ™‚ç‚¹ã§ ElasticLicense ä¸‹ã® SQL æ©Ÿèƒ½ã«ã¯å®Ÿè£…ã•ã‚Œã¦ãŠã‚‰ãšã€odfe ã® SQL ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç‹¬è‡ªã®æ©Ÿèƒ½ã¨ãªã‚Šã¾ã™ã€‚

## JOIN

### ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™

JOIN å…ˆã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®å®šç¾©ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```json
PUT /ecommerce_customer_info
{
  "mappings": {
    "properties": {
      "customer_id": {
        "type": "integer",
        "fields": {
          "keyword": {
            "type": "keyword"
          }
        }
      },
      "customer_full_name": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword"
          }
        }
      }
    }
  }
}
```

ä»®ã§ã„ãã¤ã‹ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã™ã€‚

```json
POST /_bulk
{"index": {"_index": "ecommerce_customer_info"}}
{"customer_id": 1, "customer_full_name": "Eddie Underwood"}
{"index": {"_index": "ecommerce_customer_info"}}
{"customer_id": 2, "customer_full_name": "Mary Bailey"}
{"index": {"_index": "ecommerce_customer_info"}}
{"customer_id": 3, "customer_full_name": "Gwen Butler"}
{"index": {"_index": "ecommerce_customer_info"}}
{"customer_id": 4, "customer_full_name": "Diane Chandler"}
```

### ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œ

ã“ã“ã‹ã‚‰å…ˆã¯ç¾åœ¨ã® Query Workbench ã§ã¯å¯¾å¿œã—ã¦ãã‚Œãªã‹ã£ãŸã®ã§ã€Dev Tools ã‹ã‚‰å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```sql
SELECT e.customer_id
FROM kibana_sample_data_ecommerce k
INNER JOIN ecommerce_customer_info e
  ON k.customer_full_name = e.customer_full_name
```

```json:ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
POST _opendistro/_sql
{
  "query": """
  SELECT e.customer_id
  FROM kibana_sample_data_ecommerce k
  INNER JOIN ecommerce_customer_info e
    ON k.customer_full_name = e.customer_full_name
  """
}
```

```json:è¿”å´å€¤
{
  "schema": [{
    "name": "e.customer_id",
    "type": "keyword"
  }],
  "total": 8,
  "datarows": [
    [1],
    [2],
    [2],
    [2],
    [3],
    [3],
    [4],
    [4]
  ],
  "size": 8,
  "status": 200
}
```

Explain API ã‚’ç”¨ã„ã¦å®Ÿéš›ã©ã®æ§˜ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãªã£ã¦ã„ã‚‹ã‹ã¿ã¦ã¿ã¾ã—ã‚‡ã†

```json:ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
POST _opendistro/_sql/_explain
{
  "query": """
  SELECT e.customer_id
  FROM kibana_sample_data_ecommerce k
  INNER JOIN ecommerce_customer_info e
    ON k.customer_full_name = e.customer_full_name
  """
}
```

```json:è¿”å´å€¤
{
  "Physical Plan" : {
    "Project [ columns=[e.customer_id] ]" : {
      "Top [ count=200 ]" : {
        "BlockHashJoin[ conditions=( k.customer_full_name = e.customer_full_name ), type=INNER_JOIN, blockSize=[FixedBlockSize with size=10000] ]" : {
          "Scroll [ kibana_sample_data_ecommerce as k, pageSize=10000 ]" : {
            "request" : {
              "size" : 200,
              "from" : 0
            }
          },
          "useTermsFilterOptimization" : false,
          "Scroll [ ecommerce_customer_info as e, pageSize=10000 ]" : {
            "request" : {
              "size" : 200,
              "from" : 0,
              "_source" : {
                "excludes" : [ ],
                "includes" : [
                  "customer_id",
                  "customer_full_name"
                ]
              }
            }
          }
        }
      }
    }
  },
  "description" : "Hash Join algorithm builds hash table based on result of first query, and then probes hash table to find matched rows for each row returned by second query",
  "Logical Plan" : {
    "Project [ columns=[e.customer_id] ]" : {
      "Top [ count=200 ]" : {
        "Join [ conditions=( k.customer_full_name = e.customer_full_name ) type=INNER_JOIN ]" : {
          "Group" : [
            {
              "Project [ columns=[k.customer_full_name] ]" : {
                "TableScan" : {
                  "tableAlias" : "k",
                  "tableName" : "kibana_sample_data_ecommerce"
                }
              }
            },
            {
              "Project [ columns=[e.customer_full_name, e.customer_id] ]" : {
                "TableScan" : {
                  "tableAlias" : "e",
                  "tableName" : "ecommerce_customer_info"
                }
              }
            }
          ]
        }
      }
    }
  }
}
```

Elasticsearch ã®ã‚¯ã‚¨ãƒªã§ãªã„ä½•ã‹ãŒã§ã¦ãã¾ã—ãŸã€‚[å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://opendistro.github.io/for-elasticsearch-docs/docs/sql/complex/)ã‚’å‚ç…§ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®æ§˜ãªè¨˜è¿°ãŒã‚ã‚Šã¾ã™ã€‚

> Inner join creates a new result set by combining columns of two indices based on your join predicates. It iterates the two indices and compares each document to find the ones that satisfy the join predicates. You can optionally precede the JOIN clause with an INNER keyword.

ã–ã£ãã‚Šè¨³ã™ã¨ã€ Inner Join ã®çµæœã‚’ä½œã‚‹ãŸã‚ã«ã€2 ã¤ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä¸­ã‹ã‚‰ join ã®ã‚­ãƒ¼ã«ãªã‚‹ã‚«ãƒ©ãƒ ã‚’èµ°æŸ»ã—ã¦ç…§ã‚‰ã—åˆã‚ã›ã¦ã„ã‚‹æ§˜ã§ã™ã€‚ã™ã”ã„ã€‚

# å…¨æ–‡æ¤œç´¢

ã“ã“ã¾ã§ã¯ä¸€èˆ¬çš„ãª SQL ã®ã‚¯ã‚¨ãƒªæ§‹æ–‡ã‚’ã¿ã¦ãã¾ã—ãŸãŒã€odfe ã® SQL ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã¯ Match ã‚„ Match Phrase ç­‰ã€[ä¸€éƒ¨ã®ã‚¯ã‚¨ãƒª](https://opendistro.github.io/for-elasticsearch-docs/docs/sql/sql-full-text/)ã«ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚ä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## åå‰ãŒ smith ã«ãƒãƒƒãƒã™ã‚‹é¡§å®¢ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—

```sql
SELECT * FROM kibana_sample_data_ecommerce WHERE MATCH_QUERY(customer_full_name, 'smith');
```

```json
{
  "from": 0,
  "size": 200,
  "query": {
    "bool": {
      "filter": [
        {
          "bool": {
            "must": [
              {
                "match": {
                  "customer_full_name": {
                    "query": "smith",
                    "operator": "OR",
                    "prefix_length": 0,
                    "max_expansions": 50,
                    "fuzzy_transpositions": true,
                    "lenient": false,
                    "zero_terms_query": "NONE",
                    "auto_generate_synonyms_phrase_query": true,
                    "boost": 1
                  }
                }
              }
            ],
            "adjust_pure_negative": true,
            "boost": 1
          }
        }
      ],
      "adjust_pure_negative": true,
      "boost": 1
    }
  }
}
```

![match_result](https://storage.googleapis.com/zenn-user-upload/yhs4j7qbyw6hhogh7jtfypwxwcch)
è¦‹äº‹ã€customer_full_name ã« smith ãŒå«ã¾ã‚Œã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã§ãã¾ã—ãŸã€‚

# æœ€å¾Œã«

æœ¬æŠ•ç¨¿ã§ã¯ã€Open Distro for Elasticseach ã® SQL ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ã‚’ä¸€éƒ¨ç´¹ä»‹ã„ãŸã—ã¾ã—ãŸã€‚
å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã‚‹ã¨ã€SQL ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¯èƒ½ã ã‘ã§ã¯ãªãã€ãã®ã‚¯ã‚¨ãƒªãŒã©ã†å¤‰æ›ã•ã‚Œã‚‹ã‹ã‚’ã¿ã‚‹ã“ã¨ã§ã‚ˆã‚Š Elasticsearch ã®ã‚¯ã‚¨ãƒªã¸ã®ç†è§£ã‚’æ·±ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

# å‚è€ƒ

[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://opendistro.github.io/for-elasticsearch-docs/docs/sql/)
[Docker ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ«ãƒãƒãƒ¼ãƒ‰ã§ Open Distro for Elasticsearch ã®ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã‚’æ§‹ç¯‰](https://qiita.com/ke-bo/items/690f57a3337e694afc7e)
